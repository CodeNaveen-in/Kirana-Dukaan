{% extends 'layout.html' %}

{% block content %}
    <h1>Advanced Product Search</h1>

    <form method="get" action="{{ url_for('main.index') }}" class="mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" class="form-control" name="q" placeholder="Search products by name or description..." value="{{ query }}">
            </div>
            <div class="col-md-2">
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|string %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="min_price" placeholder="Min Price" value="{{ min_price }}" min="0" step="0.01">
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control" name="max_price" placeholder="Max Price" value="{{ max_price }}" min="0" step="0.01">
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" type="submit">Search & Filter</button>
            </div>
        </div>
    </form>

    {% if products %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Search Results ({{ products|length }} products found)</h2>
            <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Clear Filters</a>
        </div>

        {% if query or category_filter or min_price or max_price %}
        <div class="alert alert-info mb-4">
            <strong>Active Filters:</strong>
            {% if query %}Search: "{{ query }}" {% endif %}
            {% if category_filter %}
                {% for cat in categories %}
                    {% if cat.id|string == category_filter %}Category: {{ cat.name }}{% endif %}
                {% endfor %}
            {% endif %}
            {% if min_price %}Min Price: ₹{{ min_price }}{% endif %}
            {% if max_price %}Max Price: ₹{{ max_price }}{% endif %}
        </div>
        {% endif %}

        <div class="row">
            {% for product in products %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ product.name }}</h5>
                        <p class="card-text">{{ product.description }}</p>
                        <p class="card-text"><strong>Price: ₹{{ product.price }}</strong></p>
                        <p class="card-text">Stock: {{ product.quantity }}</p>
                        <p class="card-text">Category: {{ product.category.name }}</p>
                        <form action="{{ url_for('main.add_to_cart', product_id=product.id) }}" method="post" class="mt-auto">
                            <div class="input-group mb-2">
                                <span class="input-group-text">Qty</span>
                                <input type="number" class="form-control" name="quantity" value="1" min="1" max="{{ product.quantity }}">
                            </div>
                            <button type="submit" class="btn btn-primary w-100" {% if product.quantity == 0 %}disabled{% endif %}>
                                {% if product.quantity == 0 %}Out of Stock{% else %}Add to Cart{% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% elif query or category_filter or min_price or max_price %}
        <div class="alert alert-warning">
            <h4>No products found</h4>
            <p>No products match your search criteria. Try adjusting your filters or <a href="{{ url_for('main.index') }}">clear all filters</a>.</p>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h4>Start Your Search</h4>
            <p>Use the filters above to find the products you're looking for.</p>
        </div>
    {% endif %}
{% endblock %}