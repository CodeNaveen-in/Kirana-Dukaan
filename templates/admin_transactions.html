{% extends 'layout.html' %}

{% block title %}Transaction Management - Kirana Dukaan{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Transaction Management</h1>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">All Transactions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Date & Time</th>
                                <th>Items</th>
                                <th>Total Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if transactions %}
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.id }}</td>
                                    <td>{{ transaction.user.username if transaction.user else 'N/A' }}</td>
                                    <td>{{ transaction.datetime.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ transaction.orders|length }}</td>
                                    <td>₹{{ "%.2f"|format(transaction.orders|sum(attribute='quantity') * (transaction.orders[0].price if transaction.orders else 0)) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transactionModal{{ transaction.id }}">View Details</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No transactions found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Detail Modals -->
{% for transaction in transactions %}
<div class="modal fade" id="transactionModal{{ transaction.id }}" tabindex="-1" aria-labelledby="transactionModalLabel{{ transaction.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel{{ transaction.id }}">Transaction #{{ transaction.id }} Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>User:</strong> {{ transaction.user.username if transaction.user else 'N/A' }}
                    </div>
                    <div class="col-md-6">
                        <strong>Date:</strong> {{ transaction.datetime.strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                </div>
                
                <h6>Order Items:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in transaction.orders %}
                            <tr>
                                <td>{{ order.product.name }}</td>
                                <td>{{ order.quantity }}</td>
                                <td>₹{{ order.price }}</td>
                                <td>₹{{ "%.2f"|format(order.quantity * order.price) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3">Grand Total:</th>
                                <th>₹{{ "%.2f"|format(transaction.orders|sum(attribute='quantity') * (transaction.orders[0].price if transaction.orders else 0)) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}